<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudinary PDF Upload Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        .upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: #f9fff9;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background: #45a049; }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        .urls {
            margin-top: 20px;
        }
        .url-item {
            margin: 10px 0;
            padding: 10px;
            background: #fff3e0;
            border-radius: 5px;
        }
        .url-item a {
            color: #0066cc;
            word-break: break-all;
        }
        .progress {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Cloudinary PDF Upload Debugger</h1>
        <p>This tool helps debug PDF upload and URL generation issues with Cloudinary.</p>
        
        <div class="upload-area">
            <h3>📄 Select a PDF File</h3>
            <input type="file" id="fileInput" accept="application/pdf">
            <br><br>
            <button onclick="uploadFile()">Upload & Test</button>
        </div>

        <div id="progressContainer" style="display: none;">
            <h3>Upload Progress</h3>
            <div class="progress">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
        </div>

        <div id="result"></div>
        
        <div id="urlsContainer" style="display: none;" class="urls">
            <h3>📎 Generated URLs</h3>
            <div class="url-item">
                <strong>Original URL:</strong><br>
                <a id="originalUrl" href="#" target="_blank">-</a>
            </div>
            <div class="url-item">
                <strong>View URL (inline):</strong><br>
                <a id="viewUrl" href="#" target="_blank">-</a>
                <br><button onclick="testUrl('viewUrl')">Test This URL</button>
            </div>
            <div class="url-item">
                <strong>Download URL:</strong><br>
                <a id="downloadUrl" href="#" target="_blank">-</a>
                <br><button onclick="testUrl('downloadUrl')">Test This URL</button>
            </div>
        </div>
    </div>

    <script>
        const CLOUD_NAME = 'dcwzukqqw';
        const UPLOAD_PRESET = 'printnsupply';

        // Test if upload preset is properly configured
        async function testUploadPreset() {
            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload_presets/${UPLOAD_PRESET}`);
                const data = await response.json();
                
                console.log('Upload Preset Configuration:', data);
                
                if (data.unsigned) {
                    console.log('✅ Preset is UNSIGNED - Good!');
                } else {
                    console.error('❌ Preset is SIGNED - This will cause issues!');
                }
                
                if (data.settings && data.settings.access_mode === 'public') {
                    console.log('✅ Access mode is PUBLIC - Good!');
                } else {
                    console.error('❌ Access mode is NOT public - Files will get 401 errors!');
                }
                
                return data;
            } catch (error) {
                console.error('❌ Failed to fetch upload preset:', error);
                console.error('The preset might not exist or is not accessible');
                return null;
            }
        }

        // Run test on page load
        window.addEventListener('load', () => {
            testUploadPreset();
        });

        function showResult(message, isError = false) {
            const result = document.getElementById('result');
            result.className = isError ? 'result error' : 'result';
            result.textContent = message;
        }

        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                showResult('Please select a file first!', true);
                return;
            }

            if (file.type !== 'application/pdf') {
                showResult('Please select a PDF file!', true);
                return;
            }

            showResult('Starting upload...');
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('urlsContainer').style.display = 'none';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);
            formData.append('folder', 'student_prints');
            formData.append('resource_type', 'raw');
            // Note: access_mode is NOT allowed with unsigned uploads
            // It's controlled by the upload preset configuration

            const xhr = new XMLHttpRequest();

            // Progress tracking
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    updateProgress(percent);
                }
            });

            // Success handler
            xhr.addEventListener('load', () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        
                        showResult('✅ Upload Successful!\n\nCloudinary Response:\n' + JSON.stringify(data, null, 2));
                        
                        // Check access mode
                        if (data.access_mode === 'public') {
                            console.log('✅ File uploaded with PUBLIC access');
                        } else {
                            console.warn('⚠️ File access mode:', data.access_mode);
                        }
                        
                        // Generate URLs - using raw resource type
                        const resourceType = 'raw';
                        const publicId = data.public_id;
                        const format = data.format;
                        const baseUrl = `https://res.cloudinary.com/${CLOUD_NAME}/${resourceType}/upload`;
                        
                        const originalUrl = data.secure_url;
                        const viewUrl = `${baseUrl}/${publicId}.${format}`;
                        const downloadUrl = `${baseUrl}/fl_attachment/${publicId}.${format}`;
                        
                        // Display URLs
                        document.getElementById('originalUrl').href = originalUrl;
                        document.getElementById('originalUrl').textContent = originalUrl;
                        
                        document.getElementById('viewUrl').href = viewUrl;
                        document.getElementById('viewUrl').textContent = viewUrl;
                        
                        document.getElementById('downloadUrl').href = downloadUrl;
                        document.getElementById('downloadUrl').textContent = downloadUrl;
                        
                        document.getElementById('urlsContainer').style.display = 'block';
                        
                        console.log('Upload Response:', data);
                        console.log('Resource Type:', resourceType);
                        console.log('Access Mode:', data.access_mode);
                        console.log('View URL:', viewUrl);
                        console.log('Download URL:', downloadUrl);
                        
                    } catch (error) {
                        showResult('❌ Failed to parse response: ' + error.message, true);
                    }
                } else {
                    const errorText = xhr.responseText;
                    showResult('❌ Upload failed with status: ' + xhr.status + '\n' + errorText, true);
                    
                    // Parse error for more details
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.error && errorData.error.message) {
                            console.error('Error details:', errorData.error.message);
                            if (errorData.error.message.includes('Upload preset')) {
                                showResult('❌ Upload Preset Error!\n\n' + errorData.error.message + '\n\nPlease check CLOUDINARY_401_FIX.md for setup instructions.', true);
                            }
                        }
                    } catch (e) {
                        console.error('Raw error:', errorText);
                    }
                }
            });

            // Error handler
            xhr.addEventListener('error', () => {
                showResult('❌ Network error occurred', true);
            });

            xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/raw/upload`);
            xhr.send(formData);
        }

        function testUrl(urlType) {
            const url = document.getElementById(urlType).href;
            window.open(url, '_blank');
        }
    </script>
</body>
</html>
